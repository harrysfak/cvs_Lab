# Σύστημα Επεξεργασίας Δεδομένων Γάλακτος

Εφαρμογή σε Python για καθαρισμό, μορφοποίηση και παραγωγή τελικού CSV από αρχεία Excel εργαστηρίου, με ενδιάμεσα zero calibration blocks. Το README εξηγεί με σαφή σειρά τι κάνει η εφαρμογή από τη στιγμή που εισάγετε το Excel μέχρι το τελικό αποτέλεσμα και πώς μπορείτε να ρυθμίσετε κάθε βήμα.

## Περιεχόμενα
- [Πώς λειτουργεί βήμα-βήμα](#πώς-λειτουργεί-βήμα-βήμα)
- [Τι συμβαίνει κατά την εισαγωγή του Excel](#τι-συμβαίνει-κατά-την-εισαγωγή-του-excel)
- [Επεξεργασία & πιθανά αποτελέσματα](#επεξεργασία--πιθανά-αποτελέσματα)
- [Τελική έξοδος που παράγεται](#τελική-έξοδος-που-παράγεται)
- [Ρυθμίσεις & παραμετροποίηση](#ρυθμίσεις--παραμετροποίηση)
- [Απαιτήσεις](#απαιτήσεις)
- [Εγκατάσταση](#εγκατάσταση)
- [Εκτέλεση](#εκτέλεση)
- [Δομή φακέλων](#δομή-φακέλων)
- [Σημειώσεις](#σημειώσεις)

## Πώς λειτουργεί βήμα-βήμα
1) **Εισαγωγή Excel**  
   - Η εφαρμογή ζητά τον αριθμό πρωτοκόλλου (π.χ. `1234-56`) και ψάχνει αρχείο με όνομα `<αριθμός>.xls` στον φάκελο εργασίας. Αν το αρχείο λείπει, εμφανίζονται τα διαθέσιμα Excel του φακέλου για να διαλέξετε σωστό όνομα. (`modules/data_loader.py`)

2) **Αρχικός καθαρισμός**  
   - Αφαιρούνται περιττές στήλες, whitespace στα headers και διπλότυπες γραμμές, γίνεται έλεγχος/μετατροπή τύπων, καθώς και μετονομασίες στηλών (π.χ. `freeze point` → `FPD`). (`modules/data_processor.py`)

3) **Έλεγχος δεκαδικών & παράγωγες τιμές**  
   - Ελέγχονται τα δεκαδικά στις βασικές στήλες (2 ή 4 δεκαδικά). Υπολογίζονται TS και SNF από Fat/Protein/Lactose. (`modules/data_processor.py`)

4) **Μεταδεδομένα χρόνου**  
   - Ζητείται ημερομηνία ανάλυσης και αρχική ώρα (ή χρησιμοποιείται τυχαία προεπιλογή). Παράγονται Sample IDs, χρονικές σφραγίδες δειγμάτων και χρόνοι για τα zero blocks με βάση το μέγεθος παρτίδας. (`modules/time_handler.py`)

5) **Zero calibration blocks**  
   - Κατεβαίνει/φορτώνεται το `zero.xlsx`, ενημερώνονται οι ημερομηνίες και οι χρόνοι, δημιουργούνται αντίγραφα για κάθε παρτίδα και παράγεται βοηθητικό `zero.csv`. (`modules/zero_manager.py`, `modules/zero_loader.py`)

6) **Σύνθεση τελικών δεδομένων**  
   - Δημιουργείται ενιαίο DataFrame με όλα τα πεδία, γίνεται προαιρετική αφαίρεση σειρών με μηδενικά Fat/Protein/Lactose, το αρχείο κόβεται σε part CSVs και συναρμολογείται σε τελικό CSV με παρεμβολή zero blocks ανά παρτίδα. Τα προσωρινά parts διαγράφονται. (`modules/output_generator.py`)

7) **Παράδοση στον χρήστη**  
   - Εμφανίζεται η διαδρομή του τελικού αρχείου, και προαιρετικά ανοίγει ο φάκελος των αποτελεσμάτων. (`main.py`)

## Τι συμβαίνει κατά την εισαγωγή του Excel
- **Ζητείται όνομα πρωτοκόλλου**: Δώστε το ακριβές όνομα αρχείου χωρίς επέκταση (π.χ. `1234-56`).  
- **Έλεγχοι ονόματος**:  
  - Τα πρώτα 4 ψηφία πρέπει να είναι αριθμοί (χρησιμοποιούνται για τα Sample IDs).  
  - Πρέπει να υπάρχει παύλα με αριθμούς μετά (`-56`) για να εξαχθεί το dash μέρος.  
- **Αν το αρχείο δεν βρεθεί**: Εμφανίζεται λίστα διαθέσιμων Excel στον φάκελο `BASE_PATH` για γρήγορο έλεγχο.  
- **Φόρτωση**: Το Excel διαβάζεται με `pandas.read_excel` (υποστηρίζονται `.xls` και `.xlsx`), εμφανίζεται συνολικός αριθμός γραμμών και προχωρά η επεξεργασία.

## Επεξεργασία & πιθανά αποτελέσματα
- **Καθαρισμός στηλών**:  
  - Στήλες στα `COLS_TO_DELETE` αφαιρούνται.  
  - Προστατεύονται βασικές στήλες (Fat, Protein, Lactose, FPD κ.λπ.) ώστε να μην διαγραφούν κατά λάθος.  
- **Δεκαδικά**: Ελέγχονται οι στήλες με 2 ή 4 δεκαδικά· τυχόν υπερβάσεις εμφανίζονται στην κονσόλα για να γνωρίζετε πόσα σημεία χρειάζονται διόρθωση.  
- **Παράγωγες στήλες**:  
  - `TS = Fat + Protein + Lactose`  
  - `SNF = Protein + Lactose + 0.7`  
- **Χρονοσήμανση**: Τα δείγματα παίρνουν χρόνο ανά 45" (προεπιλογή) και τα zero blocks ανά 20" στις παρενθέσεις τους. Το πλήθος zero blocks υπολογίζεται ανά παρτίδα `BATCH_SIZE`.  
- **Zero blocks**:  
  - Αν δεν υπάρχουν αρκετά zero blocks για τα parts, εμφανίζεται προειδοποίηση.  
  - Το `zero.xlsx` ενημερώνεται με την τρέχουσα ημερομηνία και με τους υπολογισμένους χρόνους.  
- **Πιθανά σενάρια**:  
  - **Γραμμές με 0 σε Fat/Protein/Lactose**: Αν το φίλτρο είναι ενεργό, αυτές οι γραμμές αφαιρούνται πριν τη δημιουργία parts.  
  - **Έλλειψη αρχείου zero.xlsx**: Κατεβαίνει αυτόματα από το Supabase URL του `config.py`.  
  - **Μη έγκυρες ημερομηνίες/ώρες**: Το πρόγραμμα ζητά νέα είσοδο ή χρησιμοποιεί ασφαλή προεπιλογή.

## Τελική έξοδος που παράγεται
- **Τελικό CSV**:  
  - Περιλαμβάνει Sample IDs, Rep, Product, Fat, Protein, Lactose, FPD, TS, SNF, Date, Time, Remark.  
  - Τα parts συγχωνεύονται σε ένα αρχείο και ανάμεσα στα parts εισάγονται τα zero blocks.  
- **Βοηθητικά αρχεία**:  
  - `parts/p*.csv`: Προσωρινά κομμάτια ανά παρτίδα (διαγράφονται στο τέλος αν η συναρμολόγηση ολοκληρωθεί).  
  - `zero/zero.xlsx` και `zero.csv`: Το template και η ενημερωμένη εκδοχή του zero block.  
- **Τοποθεσία**: Από προεπιλογή, το τελικό αρχείο γράφεται στο `FINAL_OUTPUT_PATH` (π.χ. `C:/excel/final.csv`). Το όνομα μπορεί να προσαρμοστεί μέσω `config.py`.

## Ρυθμίσεις & παραμετροποίηση
Όλα βρίσκονται στο `config.py`:
- **Διαδρομές**  
  - `BASE_PATH`: Φάκελος με τα εισαγόμενα Excel (π.χ. `C:/excel`).  
  - `ZERO_PATH`: Θέση του `zero.xlsx` (π.χ. `./zero/zero.xlsx`).  
  - `PARTS_PATH`: Φάκελος για προσωρινά part CSVs.  
  - `FINAL_OUTPUT_PATH` / `OUTPUT_PATH`: Τοποθεσία τελικού CSV.
- **Επεξεργασία δεδομένων**  
  - `COLS_TO_DELETE`: Στήλες που αφαιρούνται αυτόματα.  
  - `COLUMN_RENAMES`: Μετονομασίες πριν την επεξεργασία.  
  - `DROP_ZERO_NUTRIENTS`: Αν `True`, αφαιρούνται σειρές όπου Fat, Protein και Lactose είναι όλα 0.  
  - `TWO_DECIMAL_COLS` / `FOUR_DECIMAL_COLS`: Έλεγχος δεκαδικών.  
- **Χρονομέτρηση & zero blocks**  
  - `BATCH_SIZE`: Μέγεθος παρτίδας δειγμάτων (καθορίζει πόσα zero blocks θα μπουν).  
  - `T_SAMPLE_INCREMENT`: Βήμα χρόνου ανά δείγμα (δευτερόλεπτα).  
  - `T_ZERO_INCREMENT`: Βήμα χρόνου ανά γραμμή zero block.  
  - `ZERO_BLOCK_ROWS`, `ZERO_ROW_INDEX`: Σχήμα και γραμμές όπου ενημερώνονται τα timestamps.  
- **Προεπιλογές εμφάνισης**  
  - `DEFAULT_PRODUCT`, `DEFAULT_REP`, `DEFAULT_TIME`: Χρησιμοποιούνται για συμπλήρωση στα μεταδεδομένα και στην προεπιλεγμένη ώρα.

Για αυτόματη δημιουργία δομής φακέλων και έλεγχο ρυθμίσεων:
```bash
python config.py
```

## Απαιτήσεις
- Python 3.9+
- Βιβλιοθήκες:
  - `pandas`
  - `openpyxl`
  - `xlrd`
  - `numpy`
  - `requests`

## Εγκατάσταση
### Windows (One-Click)
1. Κάντε διπλό κλικ στο `install_one_click.bat`.
2. Περιμένετε να ολοκληρωθεί η εγκατάσταση.
3. Εκτελέστε:
   - `run_gui.bat` για GUI, ή
   - `python main.py` για CLI (μέσα από το `.venv`).

> Το script δημιουργεί `.venv`, εγκαθιστά τις βιβλιοθήκες και τρέχει το `config.py`.

### Χειροκίνητα (Windows/macOS/Linux)
```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -r requirements.txt
```

> Αν δεν υπάρχει `requirements.txt`, εγκαταστήστε τα packages χειροκίνητα:
```bash
pip install pandas openpyxl xlrd numpy requests
```

## Ρυθμίσεις (γρήγορη υπενθύμιση)
- Άνοιγμα/τροποποίηση: `config.py`.
- Ελάχιστα που πρέπει να ορίσετε:
  - `BASE_PATH`: Πού βρίσκονται τα αρχεία Excel.
  - `OUTPUT_PATH` / `FINAL_OUTPUT_PATH`: Πού θα γραφτεί το τελικό CSV.
  - `ZERO_PATH`: Πού θα φυλαχθεί το `zero.xlsx` (κατεβαίνει αν λείπει).
- Για να δημιουργηθούν αυτόματα οι κατάλληλοι φάκελοι, τρέξτε:
  ```bash
  python config.py
  ```

## Εκτέλεση
Κύρια εκτέλεση:
```bash
python main.py
```

Θα ζητηθεί:
1. Αρ. πρωτοκόλλου εργαστηρίου (π.χ. `1234-56`).
2. Ημερομηνία ανάλυσης (DD-MM).
3. Αρχική ώρα (HH:MM) ή Enter για προεπιλογή.

Το τελικό αρχείο θα αποθηκευτεί στο `FINAL_OUTPUT_PATH`.

## Δομή φακέλων
```
.
├── main.py
├── config.py
├── modules/
│   ├── data_loader.py
│   ├── data_processor.py
│   ├── time_handler.py
│   ├── zero_manager.py
│   ├── zero_loader.py
│   └── output_generator.py
├── parts/        # δημιουργείται αυτόματα για τα προσωρινά parts
├── zero/         # template & ενημερωμένο zero.xlsx
└── README.md
```

## Σημειώσεις
- Το πρόγραμμα είναι προσανατολισμένο σε Windows paths. Αν εκτελείτε σε άλλο OS, ενημερώστε το `BASE_PATH` στο `config.py`.
- Το `zero.xlsx` κατεβαίνει αυτόματα αν δεν υπάρχει τοπικά (Supabase URL στο `config.py`).
